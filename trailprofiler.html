<!DOCTYPE html>

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

<div id="app">
    <div class="container m-5">
        <h1>Trail Data</h1>
        <table>
            <tr>
                <th>Date</th>
                <th>Name</th>
                <th>Points</th>
                <th>Time (sec)</th>
                <th>Distance (mi)</th>
            </tr>
            <tr v-for="sequence in sequences">
                <td>{{ sequence.points[0].time | to_datestring }}</td>
                <th>{{ sequence.name }}</th>
                <td>{{ sequence.points.length }}</td>
                <td>{{ sequence.total_time }}</td>
                <td>{{ sequence.total_distance }}</td>
            </tr>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>

<script>

    let vm = new Vue({
        el: '#app',
        data: {
            sequences: []
        },
        filters: {
            to_datestring: function (epoch) {
                if (!epoch) return ''
                converted = new Date(epoch);
                return converted.toDateString();
            }
        }
    });

    // sequence = {
    //     name: '',
    //     points: []
    // }
    
function getDeltaDistanceInMiles(lat1, lon1, lat2, lon2) {
    var R = 3956; // Radius of the earth in miles
    var dLat = deg2rad(lat2-lat1);  // deg2rad below
    var dLon = deg2rad(lon2-lon1); 
    var a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
        Math.sin(dLon/2) * Math.sin(dLon/2); 
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
    var d = R * c; // Distance in miles
    return d;
}

function deg2rad(deg) {
    return deg * (Math.PI/180)
}

// hardcode sample data for now

// Track_2014-06-30 (A) UNESCO.gpx
let file0_txt = `
        <trk>
        <name>2014-06-30 HIKE #1 THINGVELLIR</name>
        <extensions>
        <gpxx:TrackExtension>
            <gpxx:DisplayColor>Cyan</gpxx:DisplayColor>
        </gpxx:TrackExtension>
        </extensions>
        <trkseg>
        <trkpt lat="64.022506875917315" lon="-21.211569970473647">
            <ele>79.780000000000001</ele>
            <time>2014-06-29T09:00:32Z</time>
        </trkpt>
        <trkpt lat="64.022516766563058" lon="-21.211741799488664">
            <ele>79.540000000000006</ele>
            <time>2014-06-29T09:00:43Z</time>
        </trkpt>
        <trkpt lat="64.022527663037181" lon="-21.211679941043258">
            <ele>79.239999999999995</ele>
            <time>2014-06-29T09:00:46Z</time>
        </trkpt>
        </trkseg>
        </trk>
    `;

    // 071119LaPlanchedesBellesFillesLepuix.gpx
    let file1_txt = `
        <trk>
        <name>La Planche des Belles Filles to Lepuix</name>
        <type>hiking</type>
        <trkseg>
        <trkpt lat="47.76858796365559101104736328125" lon="6.77142717875540256500244140625">
            <ele>1087</ele>
            <time>2019-07-11T16:17:56.000Z</time>
            <extensions>
            <ns3:TrackPointExtension/>
            </extensions>
        </trkpt>
        <trkpt lat="47.7685836888849735260009765625" lon="6.771421730518341064453125">
            <ele>1087.199951171875</ele>
            <time>2019-07-11T16:17:57.000Z</time>
            <extensions>
            <ns3:TrackPointExtension/>
            </extensions>
        </trkpt>
        <trkpt lat="47.76855493895709514617919921875" lon="6.7713813297450542449951171875">
            <ele>1087.5999755859375</ele>
            <time>2019-07-11T16:18:03.000Z</time>
            <extensions>
            <ns3:TrackPointExtension/>
            </extensions>
        </trkpt>
        </trkseg>
        </trk>
    `;

    // 061919MontStMichel.gpx
    let file2_txt = `
    <trk>
    <name>Mont Saint-Michel Bay Walk</name>
    <type>walking</type>
    <trkseg>
      <trkpt lat="48.68752551265060901641845703125" lon="-1.49716020561754703521728515625">
        <ele>-19.3999996185302734375</ele>
        <time>2019-06-19T10:30:09.000Z</time>
        <extensions>
          <ns3:TrackPointExtension>
            <ns3:hr>89</ns3:hr>
          </ns3:TrackPointExtension>
        </extensions>
      </trkpt>
      <trkpt lat="48.6875022947788238525390625" lon="-1.4972189627587795257568359375">
        <ele>-18.3999996185302734375</ele>
        <time>2019-06-19T10:30:12.000Z</time>
        <extensions>
          <ns3:TrackPointExtension>
            <ns3:hr>93</ns3:hr>
          </ns3:TrackPointExtension>
        </extensions>
      </trkpt>
      <trkpt lat="48.6874810047447681427001953125" lon="-1.49728895165026187896728515625">
        <ele>-19</ele>
        <time>2019-06-19T10:30:19.000Z</time>
        <extensions>
          <ns3:TrackPointExtension>
            <ns3:hr>95</ns3:hr>
          </ns3:TrackPointExtension>
        </extensions>
      </trkpt>
      </trkseg>
      </trk>
    `;

    let files = [file0_txt, file1_txt, file2_txt];
    for (f of files) {

        let parser, xml_doc;
        let new_sequence = {};

        if (window.DOMParser)
        {
            parser = new DOMParser();
            xml_doc = parser.parseFromString(f, "text/xml");
        }
        else // Internet Explorer
        {
            xml_doc = new ActiveXObject("Microsoft.XMLDOM");
            xml_doc.async = false;
            xml_doc.loadXML(f);
        }

        new_sequence["name"] = xml_doc.getElementsByTagName("name")[0].innerHTML;
        new_sequence["points"] = [];
        let points = xml_doc.getElementsByTagName("trkpt");
        let prev_lat, prev_long, total_distance = 0;
        let prev_time, total_time = 0;
        for (p of points) {
            let new_time = new Date(p.getElementsByTagName("time")[0].innerHTML).valueOf();
            let new_point = {
                "time": new_time,
                "latitude": p.getAttribute("lat"),
                "longitude": p.getAttribute("lon"),
                "elevation": p.getElementsByTagName("ele")[0].innerHTML
            };
            if (new_sequence.points.length > 0) {
                total_distance += getDeltaDistanceInMiles(prev_lat, prev_lon, new_point.latitude, new_point.longitude);
                total_time += new_point.time - prev_time;
            }
            prev_lat = new_point.latitude;
            prev_lon = new_point.longitude;
            new_sequence["total_distance"] = total_distance;
            prev_time = new_point.time;
            new_sequence["total_time"] = total_time;

            new_sequence.points.push(new_point);
        }

        new_sequence["total_time"] /= 1000;
        vm.sequences.push(new_sequence);
    }

</script>