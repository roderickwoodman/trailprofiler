<!DOCTYPE html>

<head>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/chartist.js/latest/chartist.min.css">
    <script src="https://cdn.jsdelivr.net/chartist.js/latest/chartist.min.js"></script>
    <style>
        body {
            padding: 20px;
            font-family:arial;
        }
        #chart1 {
            padding-top:20px;
            border: 1px solid silver;
            border-radius: 10px;
            background-color: lightyellow;
            text-align: center;
        }
        button {
            margin: 2px 6px;
        }
        .isPlotted {
            border: 3px solid black;
            background-color: yellow;
        }
        .wasSplit {
            text-decoration: line-through;
        }
    </style>
</head>

<body>
    <div id="app">
        <div id="chart1" class="ct-chart" ><strong>Elevation Profile</strong></div>
        <div class="container m-5 table-responsive-sm">
            <h1>Trail Data</h1>
            <form id="file-input-form">
                <p>
                    <label for="my-file" class="btn btn-primary">Add GPX file(s)</label>
                    <input id="my-file" style="visibility:hidden;" class="m-3" name="files[]" accept=".gpx" multiple type="file" />
                </p>
            </form>
            <table class="table table-sm table-hover">
                <thead>
                    <tr>
                        <th scope="col">Date</th>
                        <th scope="col">Name</th>
                        <th scope="col">Actions</th>
                        <th scope="col">Time (sec)</th>
                        <th scope="col">Distance (mi)</th>
                        <th scope="col">Min Elev. (m)</th>
                        <th scope="col">Max Elev. (m)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="(sequence,index) in sequences">
                        <td scope="row" v-bind:class="{ wasSplit: sequence.was_split }">{{ sequence.points[0].time | to_datestring }}</td>
                        <th v-bind:class="{ wasSplit: sequence.was_split }">{{ sequence.name }}</th>
                        <td>
                            <button v-bind:class="{ isPlotted: sequence.is_plotted }" v-on:click="clickedPlotSequence(index)">p</button>
                            <button class="btn btn-xs btn-primary" v-on:click="clickedDeleteSequence(index)">d</button>
                        </td>
                        <td v-bind:class="{ wasSplit: sequence.was_split }">{{ sequence.total_time | to_hmm }}</td>
                        <td v-bind:class="{ wasSplit: sequence.was_split }">{{ sequence.total_distance | to_tenths }}</td>
                        <td v-bind:class="{ wasSplit: sequence.was_split }">{{ sequence.minimum_elevation }}</td>
                        <td v-bind:class="{ wasSplit: sequence.was_split }">{{ sequence.maximum_elevation }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</body>

<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>

<script>

let default_data = 
    {
        series: [
            {
                name: "MSM sample data",
                data: [
                    { x: 0, y: -24 },
                    { x: 0.0011741003509269622, y: -23 },
                    { x: 0.003060849045501895, y: -23 },
                    { x: 0.0034398534293005488, y: -22 },
                    { x: 0.006199662654868886, y: -22 },
                    { x: 0.007911065985546485, y: -21 },
                    { x: 0.01214552638412976, y: -20 },
                    { x: 0.015421505677892126, y: -20 },
                    { x: 0.01705831776710646, y: -20 },
                    { x: 0.0193697222855153, y: -19 },
                    { x: 0.023334319317171524, y: -19 },
                    { x: 0.026125864744601473, y: -19 },
                    { x: 0.02916366419453924, y: -19 },
                    { x: 0.0330712642792077, y: -17 },
                    { x: 0.03443140430991322, y: -16 },
                    { x: 0.03523083022993375, y: -15 },
                    { x: 0.03747041186593482, y: -15 },
                    { x: 0.037951205393715076, y: -15 },
                    { x: 0.03853192521913101, y: -15 },
                    { x: 0.0422700334634311, y: -14 },
                    { x: 0.045792010189354915, y: -13 },
                    { x: 0.04673810841308231, y: -13 },
                    { x: 0.048107700474903294, y: -12 },
                    { x: 0.04859734699331028, y: -12 },
                    { x: 0.049460540156402194, y: -12 },
                    { x: 0.05020817899680079, y: -11 },
                    { x: 0.05224590026869746, y: -11 },
                    { x: 0.05267522304613257, y: -10 },
                    { x: 0.05319688735612019, y: -10 },
                    { x: 0.05562638582474977, y: -9 },
                    { x: 0.05618925792774188, y: -9 },
                    { x: 0.058235831505843466, y: -8 },
                    { x: 0.059453542712846065, y: -8 },
                    { x: 0.06737990903007171, y: -7 },
                    { x: 0.07269026781908801, y: -6 },
                    { x: 0.07383253634823418, y: -6 },
                    { x: 0.07577900489102517, y: -6 },
                    { x: 0.07634698931196852, y: -5 },
                    { x: 0.07845161351852772, y: -4 },
                    { x: 0.08039237365005353, y: -3 },
                    { x: 0.08199568575571817, y: -2 },
                    { x: 0.08232759302069996, y: -2 },
                    { x: 0.08286379126529647, y: -2 },
                    { x: 0.08549034311116734, y: -1 },
                    { x: 0.0863107558073136, y: 0 },
                    { x: 0.08730761831005844, y: 0 },
                    { x: 0.0878372895946724, y: 0 },
                    { x: 0.09148266326913806, y: 1 },
                    { x: 0.09258127416271231, y: 1 },
                    { x: 0.09378806504232853, y: 1 },
                    { x: 0.09528089542560136, y: 1 },
                    { x: 0.0970550894219693, y: 2 },
                    { x: 0.10212527828566807, y: 3 },
                    { x: 0.10407930556341242, y: 3 },
                    { x: 0.10901154093655949, y: 4 },
                    { x: 0.11444405451785065, y: 4 },
                    { x: 0.11590616443918113, y: 4 },
                    { x: 0.11741915643216809, y: 4 },
                    { x: 0.11917826580292958, y: 4 },
                    { x: 0.12024359306721895, y: 4 },
                    { x: 0.12133288900870697, y: 4 },
                    { x: 0.124055842933358, y: 5 },
                    { x: 0.12438379557897086, y: 5 },
                    { x: 0.12473817140186104, y: 5 },
                    { x: 0.12496448341677308, y: 5 },
                    { x: 0.1256583439068159, y: 5 },
                    { x: 0.12635962777539736, y: 5 },
                    { x: 0.12726142752326808, y: 4 },
                    { x: 0.13110585085559245, y: 4 },
                    { x: 0.1374847092533743, y: 4 },
                    { x: 0.1412290580751199, y: 4 },
                    { x: 0.1419259966703954, y: 4 },
                    { x: 0.14378119030746492, y: 4 },
                    { x: 0.1475281599172836, y: 4 },
                    { x: 0.15337316047659885, y: 3 },
                    { x: 0.15563258975936825, y: 3 },
                    { x: 0.16148556104714185, y: 2 },
                    { x: 0.16302661624188391, y: 2 },
                    { x: 0.16476712942410218, y: 1 },
                    { x: 0.1679296407044945, y: 1 },
                    { x: 0.17151965754173834, y: 0 },
                    { x: 0.17308816160397167, y: 0 },
                    { x: 0.17480196159338318, y: -1 },
                    { x: 0.17526350964524834, y: -1 },
                    { x: 0.17713156420837942, y: -2 },
                    { x: 0.17889961693153442, y: -3 },
                    { x: 0.18146681797208342, y: -5 },
                    { x: 0.18398531193802647, y: -6 },
                    { x: 0.18827871605514462, y: -7 },
                    { x: 0.19289220851563849, y: -8 },
                    { x: 0.1942225888694716, y: -8 },
                    { x: 0.20018925015602917, y: -9 },
                    { x: 0.20312238391023751, y: -10 },
                    { x: 0.20385969760169548, y: -11 },
                    { x: 0.20445345008978974, y: -11 },
                    { x: 0.20537226682855927, y: -11 },
                    { x: 0.20602627690338376, y: -12 },
                    { x: 0.20741492225819297, y: -12 },
                    { x: 0.20866597704127615, y: -13 },
                    { x: 0.21294223159758716, y: -13 },
                    { x: 0.2153662960679426, y: -14 },
                    { x: 0.21645226003918538, y: -14 },
                    { x: 0.22044081553599246, y: -14 },
                    { x: 0.22183723542231673, y: -15 },
                    { x: 0.22199746095719908, y: -15 },
                    { x: 0.22411097017186327, y: -15 },
                    { x: 0.2298317889188429, y: -16 },
                    { x: 0.2305155516553488, y: -16 },
                    { x: 0.23488873032056404, y: -17 },
                    { x: 0.2385421459745221, y: -18 },
                    { x: 0.2410788104391585, y: -19 },
                    { x: 0.24200757919387927, y: -19 },
                    { x: 0.24293965867072354, y: -19 },
                    { x: 0.2487129125770052, y: -21 },
                    { x: 0.25332059576335747, y: -22 },
                    { x: 0.25604029249106924, y: -22 },
                    { x: 0.25763426649961096, y: -23 },
                    { x: 0.26409029411077445, y: -24 },
                    { x: 0.2681993115913712, y: -24 },
                    { x: 0.2695614388216754, y: -25 },
                    { x: 0.270483817098306, y: -25 },
                    { x: 0.2746743423696007, y: -26 },
                    { x: 0.27581977222384046, y: -26 },
                    { x: 0.2784608325148796, y: -27 },
                    { x: 0.28037030176430017, y: -27 },
                    { x: 0.284516303007716, y: -28 },
                    { x: 0.2852254427436732, y: -28 },
                    { x: 0.2896681938420705, y: -30 },
                    { x: 0.2928191996086896, y: -31 },
                    { x: 0.29423698835001866, y: -31 },
                    { x: 0.29576761759874104, y: -31 },
                    { x: 0.29883268671522806, y: -32 },
                    { x: 0.308390759930441, y: -33 },
                    { x: 0.3089745233633547, y: -33 },
                    { x: 0.3124394500653171, y: -34 },
                    { x: 0.31342357904262674, y: -34 },
                    { x: 0.31441056223272823, y: -34 },
                    { x: 0.3170671163584277, y: -34 },
                    { x: 0.3198941732947844, y: -35 },
                    { x: 0.32718975904723807, y: -35 },
                    { x: 0.33174988879586786, y: -34 },
                    { x: 0.33268289423027536, y: -34 },
                    { x: 0.33353137871993555, y: -34 },
                    { x: 0.3373655129996522, y: -34 },
                    { x: 0.34427616127321403, y: -33 },
                    { x: 0.3454628958347817, y: -33 },
                    { x: 0.34949987175423564, y: -33 },
                    { x: 0.35209270044603425, y: -34 },
                    { x: 0.3529783755539459, y: -34 },
                    { x: 0.3555888626175215, y: -34 },
                    { x: 0.3598163888236042, y: -35 },
                    { x: 0.3635059094118395, y: -35 },
                    { x: 0.36389833196691423, y: -36 },
                    { x: 0.36447114640530437, y: -36 },
                    { x: 0.3648703851740126, y: -36 },
                    { x: 0.3658470710590934, y: -36 },
                    { x: 0.36640738319609945, y: -36 },
                    { x: 0.36709513568312685, y: -36 },
                    { x: 0.36732330491630316, y: -36 },
                    { x: 0.36788771485614175, y: -36 },
                    { x: 0.36820847667919465, y: -36 },
                    { x: 0.3687257353877731, y: -36 },
                    { x: 0.3695002431693429, y: -36 },
                    { x: 0.36963279660728154, y: -36 },
                    { x: 0.3698932304646193, y: -36 },
                    { x: 0.37023802526471183, y: -36 },
                    { x: 0.37030058293896345, y: -36 },
                    { x: 0.37135182640684455, y: -36 },
                    { x: 0.37160069341004526, y: -35 },
                    { x: 0.37214622902955086, y: -35 },
                    { x: 0.37240023796630906, y: -35 },
                    { x: 0.37310629940327944, y: -35 },
                    { x: 0.37324519469739736, y: -35 },
                    { x: 0.3733502956663526, y: -35 },
                    { x: 0.37380879475644774, y: -35 },
                    { x: 0.3740928494174129, y: -35 },
                    { x: 0.37470385277481066, y: -35 },
                    { x: 0.3751156492037957, y: -35 },
                    { x: 0.37637316248470865, y: -35 },
                    { x: 0.3788418305905431, y: -35 },
                    { x: 0.38105354079510256, y: -35 },
                    { x: 0.3836122184473644, y: -35 },
                    { x: 0.38379153436477986, y: -35 },
                    { x: 0.38383204549223093, y: -35 },
                    { x: 0.3847973310491812, y: -35 },
                    { x: 0.38587259073713753, y: -35 },
                    { x: 0.3861329162937944, y: -35 },
                ]
            }, {
                name: "Thingvellir sample data",
                data: [
                    { x: 0, y: 79 },
                    { x: 0.005241312216253294, y: 79 },
                    { x: 0.007257713719584238, y: 79 },
                    { x: 0.011623428217783798, y: 79 },
                    { x: 0.01223500336770542, y: 79 },
                    { x: 0.012433143900210641, y: 81 },
                    { x: 0.0129351026882409, y: 78 },
                    { x: 0.015585538098780823, y: 77 },
                    { x: 0.01648400176688193, y: 78 },
                    { x: 0.016979154985034075, y: 79 },
                    { x: 0.01784624596534578, y: 79 },
                    { x: 0.01960576137638963, y: 79 },
                    { x: 0.02003333671916823, y: 79 },
                    { x: 0.02089570461725008, y: 79 },
                    { x: 0.0218232448540163, y: 78 },
                    { x: 0.02333135484251824, y: 79 },
                    { x: 0.025807115757020015, y: 79 },
                    { x: 0.026418400567337925, y: 78 },
                    { x: 0.026890712120530666, y: 79 },
                    { x: 0.027494132099017077, y: 78 },
                    { x: 0.028478010484264186, y: 78 },
                    { x: 0.030246855351044623, y: 78 },
                    { x: 0.030611346247758093, y: 78 },
                    { x: 0.03295462865720387, y: 79 },
                    { x: 0.03351826160003547, y: 76 },
                    { x: 0.03362255636939266, y: 79 },
                    { x: 0.03413313124802274, y: 79 },
                    { x: 0.03555910631324145, y: 75 },
                    { x: 0.035751871383849824, y: 79 },
                    { x: 0.03597071823635557, y: 82 },
                    { x: 0.03611614516254447, y: 78 },
                    { x: 0.036607957161249066, y: 78 },
                    { x: 0.03726899758906155, y: 78 },
                    { x: 0.03797510829534846, y: 78 },
                    { x: 0.03814461871567188, y: 69 },
                    { x: 0.03820080657158172, y: 69 },
                    { x: 0.03823635340119424, y: 75 },
                    { x: 0.03827231130576315, y: 75 },
                    { x: 0.03893593922098248, y: 75 },
                    { x: 0.03994232617200865, y: 75 },
                    { x: 0.04062506455997576, y: 76 },
                    { x: 0.04148438600108098, y: 76 },
                    { x: 0.041967587677468166, y: 75 },
                    { x: 0.04407159651136294, y: 76 },
                    { x: 0.04517946558221779, y: 76 },
                    { x: 0.047998309356213575, y: 76 },
                    { x: 0.04893764171121205, y: 76 },
                    { x: 0.05775244977963827, y: 76 },
                    { x: 0.06327442276994985, y: 76 },
                    { x: 0.07912546785988495, y: 76 },
                    { x: 0.09101900343169536, y: 76 },
                    { x: 0.09220652662481392, y: 76 },
                    { x: 0.09722506706062979, y: 76 },
                    { x: 0.10904074024178662, y: 76 },
                    { x: 0.12294253837293981, y: 77 },
                    { x: 0.13447203155216872, y: 76 },
                    { x: 0.14780775566848803, y: 77 },
                    { x: 0.1575359480208945, y: 78 },
                    { x: 0.16821699519157585, y: 79 },
                    { x: 0.17129694975647466, y: 80 },
                    { x: 0.17271813129419913, y: 79 },
                    { x: 0.17358355299112116, y: 79 },
                    { x: 0.18140973894482965, y: 79 },
                    { x: 0.19233986289998584, y: 81 },
                    { x: 0.20246484323698707, y: 81 },
                    { x: 0.2168111389793209, y: 81 },
                    { x: 0.2237532885092557, y: 81 },
                    { x: 0.2297700248590781, y: 81 },
                    { x: 0.23298701846192493, y: 81 },
                    { x: 0.2356212583130956, y: 81 },
                    { x: 0.24357198557452564, y: 82 },
                    { x: 0.25056925067085833, y: 82 },
                    { x: 0.2590372469414736, y: 83 },
                    { x: 0.26104941986664754, y: 84 },
                    { x: 0.2631970511942451, y: 83 },
                    { x: 0.2681378433789493, y: 85 },
                    { x: 0.2765836391294039, y: 87 },
                    { x: 0.2829264837932413, y: 89 },
                    { x: 0.29210688329934476, y: 91 },
                    { x: 0.30317724074607716, y: 93 },
                    { x: 0.3102711356315554, y: 95 },
                    { x: 0.3197708427168372, y: 97 },
                    { x: 0.32583532848571517, y: 99 },
                    { x: 0.33317231250946233, y: 103 },
                    { x: 0.3439337025818592, y: 105 },
                    { x: 0.35413886871058253, y: 107 },
                    { x: 0.3640876396571417, y: 108 },
                    { x: 0.3653963270600267, y: 108 },
                    { x: 0.37531731253052625, y: 111 },
                    { x: 0.3838712836955223, y: 114 },
                    { x: 0.3927556185050683, y: 116 },
                    { x: 0.3958180470517318, y: 117 },
                    { x: 0.4066744137602951, y: 120 },
                    { x: 0.4150820285631016, y: 122 },
                    { x: 0.4218655122866923, y: 125 },
                    { x: 0.4246320107477404, y: 127 },
                    { x: 0.4262319058941246, y: 126 },
                    { x: 0.42670713820359657, y: 126 },
                    { x: 0.42743054944530323, y: 126 },
                    { x: 0.42807666179053294, y: 126 },
                    { x: 0.4284127059484338, y: 126 },
                    { x: 0.4286968340124617, y: 126 },
                    { x: 0.4291412306215805, y: 126 },
                    { x: 0.4305046515982529, y: 126 },
                    { x: 0.4375959166089953, y: 128 },
                    { x: 0.4450623538625273, y: 132 },
                    { x: 0.4519033450977561, y: 134 },
                    { x: 0.46092354626317317, y: 135 },
                    { x: 0.466562787582524, y: 136 },
                    { x: 0.47692806102315183, y: 138 },
                    { x: 0.4858916812099243, y: 141 },
                    { x: 0.49056830622066694, y: 142 },
                    { x: 0.4995932378421093, y: 144 },
                    { x: 0.5083890910985799, y: 147 },
                    { x: 0.5166499650735179, y: 149 },
                    { x: 0.517160018841325, y: 149 },
                    { x: 0.5268758674360179, y: 150 },
                    { x: 0.5380993027008582, y: 151 },
                    { x: 0.5478217560220736, y: 152 },
                    { x: 0.5573017440846662, y: 153 },
                    { x: 0.568705946899486, y: 154 },
                    { x: 0.5786155756574685, y: 156 },
                    { x: 0.5862688515974732, y: 158 },
                    { x: 0.5953438525971462, y: 161 },
                    { x: 0.6038916587662283, y: 162 },
                    { x: 0.6123200748792835, y: 164 },
                    { x: 0.6198323334869851, y: 166 },
                    { x: 0.629515280117796, y: 168 },
                    { x: 0.6395565762391425, y: 170 },
                    { x: 0.6465908612599698, y: 172 },
                    { x: 0.6532677582082166, y: 173 },
                    { x: 0.6608511803409821, y: 174 },
                    { x: 0.6674126709416139, y: 174 },
                    { x: 0.6731928182796381, y: 176 },
                    { x: 0.6777421568173465, y: 177 },
                    { x: 0.6829408821931326, y: 178 },
                    { x: 0.6873970496189195, y: 181 },
                    { x: 0.6934857833231732, y: 182 },
                    { x: 0.701893458387633, y: 184 },
                    { x: 0.7066816228703418, y: 185 },
                    { x: 0.7130769531392275, y: 188 },
                    { x: 0.7206867080690906, y: 191 },
                    { x: 0.7298131027865188, y: 192 },
                    { x: 0.7381458532220846, y: 193 },
                    { x: 0.745625711937292, y: 192 },
                    { x: 0.7551608190157454, y: 194 },
                    { x: 0.7668248809393372, y: 195 },
                    { x: 0.7754652024251097, y: 196 },
                    { x: 0.7832764928231382, y: 197 },
                    { x: 0.7909448216993483, y: 198 },
                    { x: 0.7979541703579867, y: 199 },
                    { x: 0.8051326901597782, y: 201 },
                    { x: 0.8145986998041242, y: 202 },
                    { x: 0.8167744770327825, y: 204 },
                    { x: 0.8195655770396433, y: 205 },
                    { x: 0.8263758007403467, y: 208 },
                    { x: 0.8307852111680873, y: 209 },
                    { x: 0.8312103387646816, y: 209 },
                    { x: 0.8318148457477061, y: 209 },
                    { x: 0.8319287326646614, y: 209 },
                    { x: 0.8326508253536135, y: 209 },
                    { x: 0.8327159003918434, y: 209 },
                    { x: 0.8337838661354297, y: 209 },
                    { x: 0.8377859966643969, y: 209 },
                    { x: 0.8492707206287388, y: 210 },
                    { x: 0.851782114269103, y: 211 },
                    { x: 0.8627276888153919, y: 212 },
                    { x: 0.8729398091327363, y: 214 },
                    { x: 0.880042430790275, y: 217 },
                    { x: 0.8867599431922014, y: 220 },
                    { x: 0.8941780862299554, y: 222 },
                    { x: 0.901932405110656, y: 225 },
                    { x: 0.911376588819392, y: 228 },
                    { x: 0.9218199362852786, y: 230 },
                    { x: 0.9316067968991611, y: 232 },
                    { x: 0.9417208392089755, y: 235 },
                    { x: 0.9502669644423519, y: 238 },
                    { x: 0.9611362723411238, y: 239 },
                    { x: 0.9683573848337969, y: 241 },
                    { x: 0.9801116666487769, y: 242 },
                    { x: 0.9810823517178708, y: 242 },
                    { x: 0.9895295414792824, y: 245 },
                    { x: 0.9956588661094761, y: 243 },
                    { x: 1.0021967279472017, y: 246 },
                    { x: 1.0042165728340688, y: 246 },
                    { x: 1.0126839770693532, y: 247 },
                    { x: 1.0258725291766513, y: 247 },
                    { x: 1.026464484804572, y: 247 },
                    { x: 1.0413924174967604, y: 247 },
                    { x: 1.0529292427529129, y: 248 },
                    { x: 1.0606554457113733, y: 251 },
                    { x: 1.0640801057650824, y: 251 },
                    { x: 1.0752138287965634, y: 253 },
                    { x: 1.0840191152557197, y: 256 },
                    { x: 1.0892842396342164, y: 257 },
                    { x: 1.0984435063914717, y: 259 },
                    { x: 1.1111760551414864, y: 259 },
                    { x: 1.1248836894789649, y: 256 },
                    { x: 1.1381100941612845, y: 254 },
                    { x: 1.150159388699207, y: 251 },
                    { x: 1.1555696154341764, y: 250 },
                    { x: 1.1569468827012583, y: 249 },
                    { x: 1.167355188773266, y: 249 },
                    { x: 1.1761982600474954, y: 248 },
                    { x: 1.177780750413369, y: 248 },
                    { x: 1.1867018930884579, y: 251 },
                    { x: 1.193513788498883, y: 254 },
                    { x: 1.2003012353046942, y: 258 },
                    { x: 1.2089888553280543, y: 260 },
                    { x: 1.2169020547676188, y: 260 },
                    { x: 1.2262828798062628, y: 260 },
                    { x: 1.235915831898348, y: 260 },
                    { x: 1.23810476511129, y: 259 },
                    { x: 1.2394406489943528, y: 258 },
                    { x: 1.2469844505343404, y: 257 },
                    { x: 1.2471932356031754, y: 257 },
                    { x: 1.2557925343271248, y: 258 },
                    { x: 1.2631706421298565, y: 257 },
                    { x: 1.2772301105901644, y: 258 },
                    { x: 1.2789274178921846, y: 258 },
                    { x: 1.2801040981478724, y: 257 },
                    { x: 1.2808563224011635, y: 257 },
                    { x: 1.2820323734708121, y: 257 },
                    { x: 1.2836590818126328, y: 258 },
                    { x: 1.2840303661213979, y: 257 },
                    { x: 1.2867756261053924, y: 258 },
                    { x: 1.2880453708932427, y: 257 },
                    { x: 1.2910274777026451, y: 257 },
                    { x: 1.2912022312444564, y: 258 },
                    { x: 1.2924242038152969, y: 257 },
                    { x: 1.2989719534502504, y: 257 } ]
            }, {
                name: "PDBF sample data",
                data: [
                    { x: 0.8008919992190523, y: 1028 },
                    { x: 0.8042717274966381, y: 1027 },
                    { x: 0.8052190909667605, y: 1027 },
                    { x: 0.8078056628182247, y: 1026 },
                    { x: 0.8082864490760844, y: 1026 },
                    { x: 0.8101777836581973, y: 1026 },
                    { x: 0.8115941824582192, y: 1026 },
                    { x: 0.815390442968813, y: 1026 },
                    { x: 0.8169004488091832, y: 1026 },
                    { x: 0.8183981315806833, y: 1025 },
                    { x: 0.8198771587615905, y: 1025 },
                    { x: 0.8213683939920714, y: 1024 },
                    { x: 0.8250541787599244, y: 1023 },
                    { x: 0.8260502689247144, y: 1023 },
                    { x: 0.8279133470742311, y: 1023 },
                    { x: 0.8283026738441196, y: 1023 },
                    { x: 0.8318954668979432, y: 1022 },
                    { x: 0.8328532270214825, y: 1021 },
                    { x: 0.8356296550237021, y: 1021 },
                    { x: 0.8363487961339973, y: 1020 },
                    { x: 0.8395423426013736, y: 1019 },
                    { x: 0.8427497857911445, y: 1018 },
                    { x: 0.8428566948459494, y: 1018 },
                    { x: 0.8438885842831197, y: 1018 },
                    { x: 0.8453301479379794, y: 1018 },
                    { x: 0.8486028018143034, y: 1017 },
                    { x: 0.8507908112424575, y: 1016 },
                    { x: 0.851540825934994, y: 1016 },
                    { x: 0.8532795080486777, y: 1015 },
                    { x: 0.8545501531047728, y: 1015 },
                    { x: 0.8579617377674583, y: 1014 },
                    { x: 0.8585636176440685, y: 1013 },
                    { x: 0.8597997931357537, y: 1013 },
                    { x: 0.8602079614283173, y: 1013 },
                    { x: 0.8607396527628137, y: 1013 },
                    { x: 0.8613337509645977, y: 1012 },
                    { x: 0.8618899349623638, y: 1012 },
                    { x: 0.8632128819590122, y: 1012 },
                    { x: 0.8650969510883427, y: 1011 },
                    { x: 0.87001303001345, y: 1010 },
                    { x: 0.8711473790016684, y: 1010 },
                    { x: 0.8752896623423905, y: 1009 },
                    { x: 0.8785339544195157, y: 1008 },
                    { x: 0.8796332374260182, y: 1008 },
                    { x: 0.8842130991539968, y: 1007 },
                    { x: 0.8857590713597687, y: 1006 },
                    { x: 0.8876495349293559, y: 1006 },
                    { x: 0.8905217834934963, y: 1005 },
                    { x: 0.8918958052426985, y: 1005 },
                    { x: 0.8933455910450023, y: 1005 },
                    { x: 0.8943363031427933, y: 1004 },
                    { x: 0.8960816756382655, y: 1004 },
                    { x: 0.8965510279922841, y: 1004 },
                    { x: 0.898262815094471, y: 1003 },
                    { x: 0.9026368120328037, y: 1002 },
                    { x: 0.904149165913379, y: 1002 },
                    { x: 0.9050173858209953, y: 1002 },
                    { x: 0.9067959331731638, y: 1002 },
                    { x: 0.9084706591506859, y: 1001 },
                    { x: 0.9088483495797577, y: 1001 },
                    { x: 0.9118542963204164, y: 1000 },
                    { x: 0.9145367631774738, y: 1000 },
                    { x: 0.9174945769380903, y: 999 },
                    { x: 0.9192846586082221, y: 998 },
                    { x: 0.9216693832770094, y: 997 },
                    { x: 0.9231508916646332, y: 997 },
                    { x: 0.9262505782679491, y: 996 },
                    { x: 0.9267518362553165, y: 996 },
                    { x: 0.9273879203138021, y: 996 },
                    { x: 0.9300387367369158, y: 995 },
                    { x: 0.9320465135951773, y: 994 },
                    { x: 0.9335051009559999, y: 994 },
                    { x: 0.9341777093097425, y: 994 },
                    { x: 0.936869998637042, y: 993 },
                    { x: 0.9393918123923535, y: 992 },
                    { x: 0.9404834673971905, y: 992 },
                    { x: 0.9418841917655714, y: 991 },
                    { x: 0.9424801229616419, y: 991 },
                    { x: 0.9434999431751885, y: 991 },
                    { x: 0.9463126951283606, y: 990 },
                    { x: 0.9470958771557689, y: 989 },
                    { x: 0.9494273151274988, y: 989 },
                    { x: 0.9501813624764941, y: 988 },
                    { x: 0.95210465884408, y: 988 },
                    { x: 0.9534578117949617, y: 987 },
                    { x: 0.9571029625530529, y: 986 },
                    { x: 0.9587438212021203, y: 986 },
                    { x: 0.9608412901937851, y: 986 },
                    { x: 0.9638264915644168, y: 985 },
                    { x: 0.964561348650485, y: 985 },
                    { x: 0.9658894112077334, y: 985 },
                    { x: 0.9676610683912842, y: 984 },
                    { x: 0.9687210426533578, y: 984 },
                    { x: 0.9694546521118178, y: 984 },
                    { x: 0.9718755428857556, y: 984 },
                    { x: 0.9732513041183373, y: 984 },
                    { x: 0.9763932239995398, y: 983 },
                    { x: 0.9780721666546397, y: 983 },
                    { x: 0.9801899685198756, y: 983 },
                    { x: 0.9839158002606302, y: 982 },
                    { x: 0.9845363188243049, y: 982 },
                    { x: 0.9880008172844131, y: 981 },
                    { x: 0.9885523821746957, y: 980 },
                    { x: 0.9916462119707438, y: 979 },
                    { x: 0.9923638376570197, y: 979 },
                    { x: 0.9952769326003589, y: 978 },
                    { x: 0.9971383195211051, y: 977 },
                    { x: 0.9985560078559669, y: 977 },
                    { x: 0.999285208150086, y: 977 } ]
            }
        ]
    };

let default_options = {
    height: '400px',
    fullWidth: true,
    chartPadding: {
        right: 40
    },
    axisX: {
        type: Chartist.FixedScaleAxis,
        divisor: 13,
        labelInterpolationFnc: function (value) {
            return Math.round(10*value)/10;
        }
    },
    axisY: {
        type: Chartist.FixedScaleAxis,
        divisor: 10,
        labelInterpolationFnc: function (value) {
            return Math.round(value/100)*100;
        }
    }
};

let vm = new Vue({
    el: '#app',
    data: {
        sequences: [],
        chart_data: default_data,
        chart_options: default_options
    },
    mounted() {
        if (localStorage.sequences) {
            this.sequences = JSON.parse(localStorage.sequences);
            // for ([index,sequence] of this.sequences.entries()) {
            //     if (sequence.is_plotted) {
            //         console.log("plotting: ", index);
            //         // this.clickedPlotSequence(index);
            //     }
            // }
        }
    },
    watch: {
        sequences: {
            handler: function (new_sequences) {
                localStorage.sequences = JSON.stringify(new_sequences);
            },
            deep: true
        }
    },
    filters: {
        to_datestring: function (epoch) {
            if (!epoch) return ''
            converted = new Date(epoch);
            return converted.toDateString();
        },
        to_hmm: function (seconds) {
            let tot = Number(seconds);
            let d = Math.floor(tot / 86400);
            let h = Math.floor(tot % 86400 / 3600);
            let m = Math.floor(tot % 86400 % 3600 / 60);
            if (d < 1 && m < 10) {
                m = '0' + m;
            }
            if (d > 0) {
                return d + 'd ' + h + 'h ' + m + 'm';
            } else {
                return h + ':' + m;
            }
        },
        to_tenths: function (number) {
            return (Math.round(10*number)/10).toFixed(1);
        }
    },
    methods: {
        clickedPlotSequence: function (sequence_num) {
            if (this.sequences[sequence_num].is_plotted) {
                removeSequenceFromChart(sequence_num);
            } else {
                addSequenceToChart(this.sequences[sequence_num]);
            }
            this.sequences[sequence_num].is_plotted = !this.sequences[sequence_num].is_plotted;
        },
        clickedDeleteSequence: function (sequence_num) {
            removeSequenceFromChart(sequence_num);
            this.sequences.splice(sequence_num, 1);
        }
    }
});

let chart = new Chartist.Line('#chart1', vm.chart_data, vm.chart_options);

function getDeltaDistanceInMiles(lat1, lon1, lat2, lon2) {
    var R = 3956; // Radius of the earth in miles
    var dLat = deg2rad(lat2-lat1);  // deg2rad below
    var dLon = deg2rad(lon2-lon1); 
    var a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
        Math.sin(dLon/2) * Math.sin(dLon/2); 
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
    var d = R * c; // Distance in miles
    return d;
}

function deg2rad(deg) {
    return deg * (Math.PI/180)
}

var arr = {	 // https://gist.github.com/Daniel-Hug/7273430

	sum: function(array) {
		var num = 0;
		for (var i = 0, l = array.length; i < l; i++) num += array[i];
		return num;
	},
	
	mean: function(array) {
		return arr.sum(array) / array.length;
	},

    median: function(array) {
        let cloned_array = [...array]; // to preserve the original order
		cloned_array.sort(function(a, b) {
			return a - b;
		});
		var mid = cloned_array.length / 2;
		return mid % 1 ? cloned_array[mid - 0.5] : (cloned_array[mid - 1] + array[mid]) / 2;
	},
	
	variance: function(array) {
		var median = arr.median(array);
		return arr.median(array.map(function(num) {
			return Math.pow(num - median, 2);
		}));
	},
	
	standardDeviation: function(array) {
		return Math.sqrt(arr.variance(array));
	},

    medianAbsoluteDeviation: function(array) {
		var median = arr.median(array);
		return arr.median(array.map(function(num) {
			return Math.abs(num - median);
		}));
	},
	
	zScores: function(array) {
		var median = arr.median(array);
		var standardDeviation = arr.standardDeviation(array);
		return array.map(function(num) {
			return parseFloat(((num - median) / standardDeviation).toFixed(2));
		});
	}
};

function addSequence(gpx_xml) {

    let parser, xml_doc;
    let new_sequence = {};

    if (window.DOMParser)
    {
        parser = new DOMParser();
        xml_doc = parser.parseFromString(gpx_xml, "text/xml");
    }
    else // Internet Explorer
    {
        xml_doc = new ActiveXObject("Microsoft.XMLDOM");
        xml_doc.async = false;
        xml_doc.loadXML(gpx_xml);
    }

    new_sequence["name"] = xml_doc.getElementsByTagName("name")[0].innerHTML;
    for (sequence of vm.sequences) {
        if (sequence.name.replace('ORIG ', '').replace('PART1 ', '').replace('PART2 ', '') === new_sequence.name) {
            return; // don't add duplicates
        }
    }
    new_sequence["points"] = [];
    let points = xml_doc.getElementsByTagName("trkpt");
    let prev_lat, prev_long, prev_time;
    let min_ele, max_ele = 0;
    let arr_distance_deltas = [];
    let arr_distance_aggrs = [];
    let arr_time_deltas = [];
    let arr_time_aggrs = [];
    for (p of points) {
        let new_time = new Date(p.getElementsByTagName("time")[0].innerHTML).valueOf();
        let new_point = {
            "time": new_time,
            "latitude": p.getAttribute("lat"),
            "longitude": p.getAttribute("lon"),
            "elevation": parseInt(p.getElementsByTagName("ele")[0].innerHTML)
        };
        let new_distance_delta = 0, new_time_delta = 0;
        if (new_sequence.points.length > 0) {
            new_distance_delta = getDeltaDistanceInMiles(prev_lat, prev_lon, new_point.latitude, new_point.longitude);
            arr_distance_deltas.push(new_distance_delta);
            arr_distance_aggrs.push(arr_distance_aggrs[arr_distance_aggrs.length - 1] + new_distance_delta);
            new_time_delta = (new_point.time - prev_time) / 1000;
            arr_time_deltas.push(new_time_delta);
            arr_time_aggrs.push(arr_time_aggrs[arr_time_aggrs.length - 1] + new_time_delta);
            max_ele = (new_point.elevation > max_ele) ? new_point.elevation : max_ele;
            min_ele = (new_point.elevation < min_ele) ? new_point.elevation : min_ele;
        } else {
            max_ele = new_point.elevation;
            min_ele = new_point.elevation;
            arr_distance_deltas.push(0);
            arr_distance_aggrs.push(0);
            arr_time_deltas.push(0);
            arr_time_aggrs.push(0);
        }
        prev_lat = new_point.latitude;
        prev_lon = new_point.longitude;
        prev_time = new_point.time;
        new_sequence.points.push(new_point);
    }
    // stats
    new_sequence["arr_distance_deltas"] = arr_distance_deltas;
    new_sequence["arr_distance_aggrs"] = arr_distance_aggrs;
    new_sequence["arr_time_deltas"] = arr_time_deltas;
    new_sequence["arr_time_aggrs"] = arr_time_aggrs;
    new_sequence["is_plotted"] = false;
    new_sequence["was_split"] = false;
    new_sequence["total_distance"] = new_sequence.arr_distance_aggrs[arr_distance_aggrs.length - 1];
    new_sequence["total_time"] = new_sequence.arr_time_aggrs[arr_time_aggrs.length - 1];
    new_sequence["maximum_elevation"] = max_ele;
    new_sequence["minimum_elevation"] = min_ele;

    // identify outliers
    new_sequence["stats_distances"] = arr_distance_deltas;
    new_sequence["stats_distances_zscores"] = arr.zScores(arr_distance_deltas);
    new_sequence["stats_times"] = arr_time_deltas;
    new_sequence["stats_times_zscores"] = arr.zScores(arr_time_deltas);
    let outliers_distances_indicies = [];
    new_sequence.stats_distances_zscores.forEach(function (score, index) {
        if (score > 100) {
            outliers_distances_indicies.push(index);
        }
    })
    let outliers_times_indicies = [];
    new_sequence.stats_times_zscores.forEach(function (score, index) {
        if (score > 100) {
            outliers_times_indicies.push(index);
        }
    })

    // find the intersection of the distance outliers and the time outliers (by index)
    outliers_times_indicies.filter(index => outliers_distances_indicies.includes(index));

    if (outliers_times_indicies.length > 0) {

        new_sequence.name = "ORIG " + new_sequence.name;
        new_sequence["was_split"] = true;
        vm.sequences.push(new_sequence);

        let splice_idx = outliers_times_indicies[0];
        let new_length, new_max_elevation, new_min_elevation;

        part1_new_sequence = JSON.parse(JSON.stringify(new_sequence));
        part1_new_sequence.was_split = false;
        part1_new_sequence.name = "PART1 " + part1_new_sequence.name;
        part1_new_sequence.points.splice(splice_idx);
        new_length = part1_new_sequence.points.length;
        part1_new_sequence.arr_distance_deltas.splice(splice_idx);
        part1_new_sequence.arr_distance_aggrs.splice(splice_idx);
        part1_new_sequence.total_distance = part1_new_sequence.arr_distance_aggrs[new_length - 1];
        part1_new_sequence.arr_time_deltas.splice(splice_idx);
        part1_new_sequence.arr_time_aggrs.splice(splice_idx);
        part1_new_sequence.total_time = part1_new_sequence.arr_time_aggrs[new_length - 1];
        new_max_elevation = part1_new_sequence.points[0].elevation;
        new_min_elevation = part1_new_sequence.points[0].elevation;
        part1_new_sequence.points.forEach(function(point) {
            if (point.elevation > new_max_elevation) {
                new_max_elevation = point.elevation;
            }
            if (point.elevation < new_min_elevation) {
                new_min_elevation = point.elevation;
            }
        })
        part1_new_sequence.maximum_elevation = new_max_elevation;
        part1_new_sequence.minimum_elevation = new_min_elevation;
        vm.sequences.push(part1_new_sequence);

        part2_new_sequence = JSON.parse(JSON.stringify(new_sequence));
        part2_new_sequence.was_split = false;
        part2_new_sequence.name = "PART2 " + part2_new_sequence.name;
        part2_new_sequence.points.splice(0, splice_idx);
        new_length = part2_new_sequence.points.length;
        part2_new_sequence.arr_distance_deltas.splice(0, splice_idx);
        part2_new_sequence.arr_distance_aggrs.splice(0, splice_idx);
        let offset_distance = part2_new_sequence.arr_distance_aggrs[0];
        part2_new_sequence.arr_distance_aggrs.forEach(function(ele, idx) {
            this[idx] -= offset_distance;
        }, part2_new_sequence.arr_distance_aggrs);
        part2_new_sequence.total_distance = part2_new_sequence.arr_distance_aggrs[new_length - 1];
        part2_new_sequence.arr_time_deltas.splice(0, splice_idx);
        part2_new_sequence.arr_time_aggrs.splice(0, splice_idx);
        let offset_time = part2_new_sequence.arr_time_aggrs[0];
        part2_new_sequence.arr_time_aggrs.forEach(function(ele, idx) {
            this[idx] -= offset_time;
        }, part2_new_sequence.arr_time_aggrs);
        part2_new_sequence.total_time = part2_new_sequence.arr_time_aggrs[new_length - 1];
        new_max_elevation = part2_new_sequence.points[0].elevation;
        new_min_elevation = part2_new_sequence.points[0].elevation;
        part2_new_sequence.points.forEach(function(point) {
            if (point.elevation > new_max_elevation) {
                new_max_elevation = point.elevation;
            }
            if (point.elevation < new_min_elevation) {
                new_min_elevation = point.elevation;
            }
        })
        part2_new_sequence.maximum_elevation = new_max_elevation;
        part2_new_sequence.minimum_elevation = new_min_elevation;
        vm.sequences.push(part2_new_sequence);

    } else {
        vm.sequences.push(new_sequence);
    }
}

function removeSequenceFromChart(sequence_num) {
    let new_chart_data = JSON.parse(JSON.stringify(vm.chart_data));
    for ([index,series] of vm.chart_data.series.entries()) {
        if (series.name === vm.sequences[sequence_num].name) {
            new_chart_data.series.splice(index, 1);
            break;
        }
    }
    vm.chart_data = new_chart_data;
    chart.update(vm.chart_data, vm.chart_options);
}

function addSequenceToChart(sequence) {
    let new_chart_data = vm.chart_data, new_series = {}, new_series_data = [];
    new_series["name"] = sequence.name;
    sequence.points.forEach(function(point, idx) {
        let chart_point = { x: sequence.arr_distance_aggrs[idx], y: point.elevation };
        new_series_data.push(chart_point);
    })
    new_series["data"] = new_series_data;
    if (new_chart_data.hasOwnProperty("series")) {
        new_chart_data.series.push(new_series);
    } else {
        new_chart_data["series"] = [new_series];
    }
    vm.chart_data = new_chart_data;
    chart.update(vm.chart_data, vm.chart_options);
}

document.forms['file-input-form'].elements['my-file'].onchange = function(evt) {
  const files = evt.currentTarget.files;
  Object.keys(files).forEach(i => {
    const file = files[i];
    const reader = new FileReader();
    reader.onload = (evt) => {
        addSequence(evt.target.result);
    }
    reader.readAsText(file);
  })
};

</script>